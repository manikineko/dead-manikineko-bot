import { Buttons, ID_NAMESPACE, autocompleteDeleteMessages, deleteMessagesOptions } from '../../core/constants.js';
import { getSettings } from '../../core/settings.js';
import { logAction, showConfirmation } from '../../core/utils.js';
import { Flashcore, logger } from 'robo.js';
import { ButtonStyle, Colors, ComponentType, PermissionFlagsBits } from 'discord.js';
export const config = {
    defaultMemberPermissions: PermissionFlagsBits.BanMembers,
    description: `Ban a member from the server`,
    dmPermission: false,
    options: [
        {
            name: 'member',
            description: 'The @member to ban',
            type: 'user',
            required: true
        },
        {
            name: 'reason',
            description: 'The reason for the ban',
            type: 'string'
        },
        {
            name: 'delete_messages',
            description: 'How much of their recent message history to delete',
            autocomplete: true
        },
        {
            name: 'duration',
            description: 'How long the ban should last',
            autocomplete: true
        },
        {
            name: 'anonymous',
            description: 'Whether to execute the ban anonymously',
            type: 'boolean'
        }
    ]
};
export default (async (interaction)=>{
    const anonymous = (interaction.options.get('anonymous')?.value) ?? false;
    const deleteMessages = interaction.options.get('delete_messages')?.value;
    const user = interaction.options.getUser('member');
    const reason = interaction.options.get('reason')?.value;
    // Validate the command
    if (!interaction.guild) {
        return 'This command can only be used in a server';
    } else if (deleteMessages && !deleteMessagesOptions.map((option)=>option.value).includes(deleteMessages)) {
        return 'Invalid delete_messages option';
    } else if (!user || interaction.memberPermissions === null) {
        return 'Invalid command usage';
    } else if (user.id === interaction.user.id) {
        return 'Sorry, you cannot ban yourself';
    } else if (user.id === interaction.client.user?.id) {
        return 'Sorry, you cannot ban me';
    }
    // Get settings
    const { logsChannelId , requireConfirmation , testMode  } = getSettings(interaction.guildId);
    // Validate permissions
    if ((interaction.memberPermissions.bitfield & PermissionFlagsBits.BanMembers) !== PermissionFlagsBits.BanMembers) {
        return 'You do not have permission to ban members';
    }
    // Prepare response embed fields
    const fields = [
        {
            name: 'Member',
            value: user.toString()
        },
        {
            name: 'Reason',
            value: reason || 'No reason provided'
        }
    ];
    // This can be achieved by fetching all channels and then fetching the last n messages from each channel asynchronously
    if (deleteMessages && !testMode) {
        fields.push({
            name: 'Messages Deleted',
            value: deleteMessages
        });
    }
    // Prepare message payload
    const deleted = deleteMessagesOptions.find((option)=>option.value === deleteMessages)?.name;
    const messagePayload = {
        embeds: [
            {
                color: Colors.DarkRed,
                title: `${user.username} was banned`,
                thumbnail: {
                    url: user.displayAvatarURL()
                },
                fields: [
                    {
                        name: 'Member',
                        value: user.toString()
                    },
                    {
                        name: 'Reason',
                        value: reason ?? 'No reason provided'
                    },
                    {
                        name: 'Messages Deleted',
                        value: deleted ?? 'None'
                    }
                ]
            }
        ],
        components: [
            {
                type: ComponentType.ActionRow,
                components: [
                    {
                        type: ComponentType.Button,
                        label: 'Unban',
                        style: ButtonStyle.Danger,
                        customId: Buttons.Unban.id + '/' + user.id
                    }
                ]
            }
        ]
    };
    // Do the actual ban - Farewell forever!
    const execute = async (interaction)=>{
        logger.warn(`Interaction:`, interaction);
        if (!testMode) {
            await interaction.guild?.members.ban(user, {
                reason
            });
            await Flashcore.set('ban', {
                reason: reason
            }, {
                namespace: ID_NAMESPACE + interaction.guildId + user.id
            });
            logger.info(`Banned @${user.username} for ${reason} in guild ${interaction.guild?.name} by @${interaction.user.username}`);
        }
        // Log action to modlogs channel if this is not it
        if (interaction.channelId !== logsChannelId) {
            const testPrefix = testMode ? '[TEST] ' : '';
            logAction(interaction.guildId, {
                embeds: [
                    {
                        title: testPrefix + `Member banned`,
                        thumbnail: {
                            url: user.displayAvatarURL()
                        },
                        description: `${user} has been banned`,
                        color: Colors.DarkRed,
                        timestamp: new Date().toISOString(),
                        footer: {
                            icon_url: interaction.user.displayAvatarURL(),
                            text: 'by @' + interaction.user.username
                        }
                    }
                ]
            });
        }
        interaction.reply({
            embeds: messagePayload.embeds,
            components: [
                {
                    type: ComponentType.ActionRow,
                    components: [
                        {
                            type: ComponentType.Button,
                            label: 'Unban',
                            style: ButtonStyle.Danger,
                            customId: Buttons.Unban.id + '/' + user.id
                        }
                    ]
                }
            ]
        });
    };
    // Test mode - don't execute ban
    const test = (interaction)=>{
        if (testMode) {
            interaction.reply({
                embeds: [
                    {
                        title: 'Test mode',
                        description: 'This is a test. No action has been taken.',
                        color: Colors.Yellow,
                        footer: {
                            text: (logsChannelId ? 'See' : 'Setup') + ` modlogs channel for details`
                        }
                    }
                ],
                ephemeral: true
            });
            return true;
        }
    };
    // Show confirmation modal if required
    if (requireConfirmation) {
        await showConfirmation(interaction, (interaction)=>{
            if (!test(interaction)) {
                execute(interaction);
            }
        });
        return;
    }
    if (test(interaction)) {
        return;
    }
    execute(interaction);
    if (anonymous) {
        interaction.channel?.send(messagePayload);
        return {
            content: 'Ban has been executed.',
            ephemeral: true
        };
    }
    return messagePayload;
});
export const autocomplete = autocompleteDeleteMessages;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3JrL3JvYm8uanMvcm9iby5qcy9wYWNrYWdlcy9wbHVnaW4tbW9kdG9vbHMvc3JjL2NvbW1hbmRzL21vZC9iYW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnV0dG9ucywgSURfTkFNRVNQQUNFLCBhdXRvY29tcGxldGVEZWxldGVNZXNzYWdlcywgZGVsZXRlTWVzc2FnZXNPcHRpb25zIH0gZnJvbSAnLi4vLi4vY29yZS9jb25zdGFudHMuanMnXG5pbXBvcnQgeyBnZXRTZXR0aW5ncyB9IGZyb20gJy4uLy4uL2NvcmUvc2V0dGluZ3MuanMnXG5pbXBvcnQgeyBsb2dBY3Rpb24sIHNob3dDb25maXJtYXRpb24gfSBmcm9tICcuLi8uLi9jb3JlL3V0aWxzLmpzJ1xuaW1wb3J0IHsgRmxhc2hjb3JlLCBsb2dnZXIgfSBmcm9tICdyb2JvLmpzJ1xuaW1wb3J0IHsgQnV0dG9uU3R5bGUsIENvbG9ycywgQ29tcG9uZW50VHlwZSwgUGVybWlzc2lvbkZsYWdzQml0cyB9IGZyb20gJ2Rpc2NvcmQuanMnXG5pbXBvcnQgdHlwZSB7IENvbW1hbmRDb25maWcsIENvbW1hbmRSZXN1bHQgfSBmcm9tICdyb2JvLmpzJ1xuaW1wb3J0IHR5cGUgeyBDaGF0SW5wdXRDb21tYW5kSW50ZXJhY3Rpb24sIE1lc3NhZ2VDcmVhdGVPcHRpb25zLCBNb2RhbFN1Ym1pdEludGVyYWN0aW9uIH0gZnJvbSAnZGlzY29yZC5qcydcblxuZXhwb3J0IGNvbnN0IGNvbmZpZzogQ29tbWFuZENvbmZpZyA9IHtcblx0ZGVmYXVsdE1lbWJlclBlcm1pc3Npb25zOiBQZXJtaXNzaW9uRmxhZ3NCaXRzLkJhbk1lbWJlcnMsXG5cdGRlc2NyaXB0aW9uOiBgQmFuIGEgbWVtYmVyIGZyb20gdGhlIHNlcnZlcmAsXG5cdGRtUGVybWlzc2lvbjogZmFsc2UsXG5cdG9wdGlvbnM6IFtcblx0XHR7XG5cdFx0XHRuYW1lOiAnbWVtYmVyJyxcblx0XHRcdGRlc2NyaXB0aW9uOiAnVGhlIEBtZW1iZXIgdG8gYmFuJyxcblx0XHRcdHR5cGU6ICd1c2VyJyxcblx0XHRcdHJlcXVpcmVkOiB0cnVlXG5cdFx0fSxcblx0XHR7XG5cdFx0XHRuYW1lOiAncmVhc29uJyxcblx0XHRcdGRlc2NyaXB0aW9uOiAnVGhlIHJlYXNvbiBmb3IgdGhlIGJhbicsXG5cdFx0XHR0eXBlOiAnc3RyaW5nJ1xuXHRcdH0sXG5cdFx0e1xuXHRcdFx0bmFtZTogJ2RlbGV0ZV9tZXNzYWdlcycsXG5cdFx0XHRkZXNjcmlwdGlvbjogJ0hvdyBtdWNoIG9mIHRoZWlyIHJlY2VudCBtZXNzYWdlIGhpc3RvcnkgdG8gZGVsZXRlJyxcblx0XHRcdGF1dG9jb21wbGV0ZTogdHJ1ZVxuXHRcdH0sXG5cdFx0e1xuXHRcdFx0bmFtZTogJ2R1cmF0aW9uJyxcblx0XHRcdGRlc2NyaXB0aW9uOiAnSG93IGxvbmcgdGhlIGJhbiBzaG91bGQgbGFzdCcsXG5cdFx0XHRhdXRvY29tcGxldGU6IHRydWVcblx0XHR9LFxuXHRcdHtcblx0XHRcdG5hbWU6ICdhbm9ueW1vdXMnLFxuXHRcdFx0ZGVzY3JpcHRpb246ICdXaGV0aGVyIHRvIGV4ZWN1dGUgdGhlIGJhbiBhbm9ueW1vdXNseScsXG5cdFx0XHR0eXBlOiAnYm9vbGVhbidcblx0XHR9XG5cdF1cbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKGludGVyYWN0aW9uOiBDaGF0SW5wdXRDb21tYW5kSW50ZXJhY3Rpb24pOiBQcm9taXNlPENvbW1hbmRSZXN1bHQ+ID0+IHtcblx0Y29uc3QgYW5vbnltb3VzID0gKGludGVyYWN0aW9uLm9wdGlvbnMuZ2V0KCdhbm9ueW1vdXMnKT8udmFsdWUgYXMgYm9vbGVhbikgPz8gZmFsc2Vcblx0Y29uc3QgZGVsZXRlTWVzc2FnZXMgPSBpbnRlcmFjdGlvbi5vcHRpb25zLmdldCgnZGVsZXRlX21lc3NhZ2VzJyk/LnZhbHVlIGFzIHN0cmluZ1xuXHRjb25zdCB1c2VyID0gaW50ZXJhY3Rpb24ub3B0aW9ucy5nZXRVc2VyKCdtZW1iZXInKVxuXHRjb25zdCByZWFzb24gPSBpbnRlcmFjdGlvbi5vcHRpb25zLmdldCgncmVhc29uJyk/LnZhbHVlIGFzIHN0cmluZ1xuXG5cdC8vIFZhbGlkYXRlIHRoZSBjb21tYW5kXG5cdGlmICghaW50ZXJhY3Rpb24uZ3VpbGQpIHtcblx0XHRyZXR1cm4gJ1RoaXMgY29tbWFuZCBjYW4gb25seSBiZSB1c2VkIGluIGEgc2VydmVyJ1xuXHR9IGVsc2UgaWYgKGRlbGV0ZU1lc3NhZ2VzICYmICFkZWxldGVNZXNzYWdlc09wdGlvbnMubWFwKChvcHRpb24pID0+IG9wdGlvbi52YWx1ZSkuaW5jbHVkZXMoZGVsZXRlTWVzc2FnZXMpKSB7XG5cdFx0cmV0dXJuICdJbnZhbGlkIGRlbGV0ZV9tZXNzYWdlcyBvcHRpb24nXG5cdH0gZWxzZSBpZiAoIXVzZXIgfHwgaW50ZXJhY3Rpb24ubWVtYmVyUGVybWlzc2lvbnMgPT09IG51bGwpIHtcblx0XHRyZXR1cm4gJ0ludmFsaWQgY29tbWFuZCB1c2FnZSdcblx0fSBlbHNlIGlmICh1c2VyLmlkID09PSBpbnRlcmFjdGlvbi51c2VyLmlkKSB7XG5cdFx0cmV0dXJuICdTb3JyeSwgeW91IGNhbm5vdCBiYW4geW91cnNlbGYnXG5cdH0gZWxzZSBpZiAodXNlci5pZCA9PT0gaW50ZXJhY3Rpb24uY2xpZW50LnVzZXI/LmlkKSB7XG5cdFx0cmV0dXJuICdTb3JyeSwgeW91IGNhbm5vdCBiYW4gbWUnXG5cdH1cblxuXHQvLyBHZXQgc2V0dGluZ3Ncblx0Y29uc3QgeyBsb2dzQ2hhbm5lbElkLCByZXF1aXJlQ29uZmlybWF0aW9uLCB0ZXN0TW9kZSB9ID0gZ2V0U2V0dGluZ3MoaW50ZXJhY3Rpb24uZ3VpbGRJZClcblxuXHQvLyBWYWxpZGF0ZSBwZXJtaXNzaW9uc1xuXHRpZiAoKGludGVyYWN0aW9uLm1lbWJlclBlcm1pc3Npb25zLmJpdGZpZWxkICYgUGVybWlzc2lvbkZsYWdzQml0cy5CYW5NZW1iZXJzKSAhPT0gUGVybWlzc2lvbkZsYWdzQml0cy5CYW5NZW1iZXJzKSB7XG5cdFx0cmV0dXJuICdZb3UgZG8gbm90IGhhdmUgcGVybWlzc2lvbiB0byBiYW4gbWVtYmVycydcblx0fVxuXG5cdC8vIFByZXBhcmUgcmVzcG9uc2UgZW1iZWQgZmllbGRzXG5cdGNvbnN0IGZpZWxkcyA9IFtcblx0XHR7XG5cdFx0XHRuYW1lOiAnTWVtYmVyJyxcblx0XHRcdHZhbHVlOiB1c2VyLnRvU3RyaW5nKClcblx0XHR9LFxuXHRcdHtcblx0XHRcdG5hbWU6ICdSZWFzb24nLFxuXHRcdFx0dmFsdWU6IHJlYXNvbiB8fCAnTm8gcmVhc29uIHByb3ZpZGVkJ1xuXHRcdH1cblx0XVxuXG5cdC8vIFRoaXMgY2FuIGJlIGFjaGlldmVkIGJ5IGZldGNoaW5nIGFsbCBjaGFubmVscyBhbmQgdGhlbiBmZXRjaGluZyB0aGUgbGFzdCBuIG1lc3NhZ2VzIGZyb20gZWFjaCBjaGFubmVsIGFzeW5jaHJvbm91c2x5XG5cdGlmIChkZWxldGVNZXNzYWdlcyAmJiAhdGVzdE1vZGUpIHtcblx0XHRmaWVsZHMucHVzaCh7XG5cdFx0XHRuYW1lOiAnTWVzc2FnZXMgRGVsZXRlZCcsXG5cdFx0XHR2YWx1ZTogZGVsZXRlTWVzc2FnZXNcblx0XHR9KVxuXHR9XG5cblx0Ly8gUHJlcGFyZSBtZXNzYWdlIHBheWxvYWRcblx0Y29uc3QgZGVsZXRlZCA9IGRlbGV0ZU1lc3NhZ2VzT3B0aW9ucy5maW5kKChvcHRpb24pID0+IG9wdGlvbi52YWx1ZSA9PT0gZGVsZXRlTWVzc2FnZXMpPy5uYW1lXG5cdGNvbnN0IG1lc3NhZ2VQYXlsb2FkOiBDb21tYW5kUmVzdWx0ID0ge1xuXHRcdGVtYmVkczogW1xuXHRcdFx0e1xuXHRcdFx0XHRjb2xvcjogQ29sb3JzLkRhcmtSZWQsXG5cdFx0XHRcdHRpdGxlOiBgJHt1c2VyLnVzZXJuYW1lfSB3YXMgYmFubmVkYCxcblx0XHRcdFx0dGh1bWJuYWlsOiB7XG5cdFx0XHRcdFx0dXJsOiB1c2VyLmRpc3BsYXlBdmF0YXJVUkwoKVxuXHRcdFx0XHR9LFxuXHRcdFx0XHRmaWVsZHM6IFtcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRuYW1lOiAnTWVtYmVyJyxcblx0XHRcdFx0XHRcdHZhbHVlOiB1c2VyLnRvU3RyaW5nKClcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdG5hbWU6ICdSZWFzb24nLFxuXHRcdFx0XHRcdFx0dmFsdWU6IHJlYXNvbiA/PyAnTm8gcmVhc29uIHByb3ZpZGVkJ1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0bmFtZTogJ01lc3NhZ2VzIERlbGV0ZWQnLFxuXHRcdFx0XHRcdFx0dmFsdWU6IGRlbGV0ZWQgPz8gJ05vbmUnXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRdXG5cdFx0XHR9XG5cdFx0XSxcblx0XHRjb21wb25lbnRzOiBbXG5cdFx0XHR7XG5cdFx0XHRcdHR5cGU6IENvbXBvbmVudFR5cGUuQWN0aW9uUm93LFxuXHRcdFx0XHRjb21wb25lbnRzOiBbXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dHlwZTogQ29tcG9uZW50VHlwZS5CdXR0b24sXG5cdFx0XHRcdFx0XHRsYWJlbDogJ1VuYmFuJyxcblx0XHRcdFx0XHRcdHN0eWxlOiBCdXR0b25TdHlsZS5EYW5nZXIsXG5cdFx0XHRcdFx0XHRjdXN0b21JZDogQnV0dG9ucy5VbmJhbi5pZCArICcvJyArIHVzZXIuaWRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdF1cblx0XHRcdH1cblx0XHRdXG5cdH1cblxuXHQvLyBEbyB0aGUgYWN0dWFsIGJhbiAtIEZhcmV3ZWxsIGZvcmV2ZXIhXG5cdGNvbnN0IGV4ZWN1dGUgPSBhc3luYyAoaW50ZXJhY3Rpb246IENoYXRJbnB1dENvbW1hbmRJbnRlcmFjdGlvbiB8IE1vZGFsU3VibWl0SW50ZXJhY3Rpb24pID0+IHtcblx0XHRsb2dnZXIud2FybihgSW50ZXJhY3Rpb246YCwgaW50ZXJhY3Rpb24pXG5cdFx0aWYgKCF0ZXN0TW9kZSkge1xuXHRcdFx0YXdhaXQgaW50ZXJhY3Rpb24uZ3VpbGQ/Lm1lbWJlcnMuYmFuKHVzZXIsIHsgcmVhc29uIH0pXG5cdFx0XHRhd2FpdCBGbGFzaGNvcmUuc2V0KFxuXHRcdFx0XHQnYmFuJyxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJlYXNvbjogcmVhc29uXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRuYW1lc3BhY2U6IElEX05BTUVTUEFDRSArIGludGVyYWN0aW9uLmd1aWxkSWQgKyB1c2VyLmlkXG5cdFx0XHRcdH1cblx0XHRcdClcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHRgQmFubmVkIEAke3VzZXIudXNlcm5hbWV9IGZvciAke3JlYXNvbn0gaW4gZ3VpbGQgJHtpbnRlcmFjdGlvbi5ndWlsZD8ubmFtZX0gYnkgQCR7aW50ZXJhY3Rpb24udXNlci51c2VybmFtZX1gXG5cdFx0XHQpXG5cdFx0fVxuXG5cdFx0Ly8gTG9nIGFjdGlvbiB0byBtb2Rsb2dzIGNoYW5uZWwgaWYgdGhpcyBpcyBub3QgaXRcblx0XHRpZiAoaW50ZXJhY3Rpb24uY2hhbm5lbElkICE9PSBsb2dzQ2hhbm5lbElkKSB7XG5cdFx0XHRjb25zdCB0ZXN0UHJlZml4ID0gdGVzdE1vZGUgPyAnW1RFU1RdICcgOiAnJ1xuXHRcdFx0bG9nQWN0aW9uKGludGVyYWN0aW9uLmd1aWxkSWQsIHtcblx0XHRcdFx0ZW1iZWRzOiBbXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dGl0bGU6IHRlc3RQcmVmaXggKyBgTWVtYmVyIGJhbm5lZGAsXG5cdFx0XHRcdFx0XHR0aHVtYm5haWw6IHtcblx0XHRcdFx0XHRcdFx0dXJsOiB1c2VyLmRpc3BsYXlBdmF0YXJVUkwoKVxuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdGRlc2NyaXB0aW9uOiBgJHt1c2VyfSBoYXMgYmVlbiBiYW5uZWRgLFxuXHRcdFx0XHRcdFx0Y29sb3I6IENvbG9ycy5EYXJrUmVkLFxuXHRcdFx0XHRcdFx0dGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG5cdFx0XHRcdFx0XHRmb290ZXI6IHtcblx0XHRcdFx0XHRcdFx0aWNvbl91cmw6IGludGVyYWN0aW9uLnVzZXIuZGlzcGxheUF2YXRhclVSTCgpLFxuXHRcdFx0XHRcdFx0XHR0ZXh0OiAnYnkgQCcgKyBpbnRlcmFjdGlvbi51c2VyLnVzZXJuYW1lXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRdXG5cdFx0XHR9KVxuXHRcdH1cblxuXHRcdGludGVyYWN0aW9uLnJlcGx5KHtcblx0XHRcdGVtYmVkczogbWVzc2FnZVBheWxvYWQuZW1iZWRzLFxuXHRcdFx0Y29tcG9uZW50czogW1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0dHlwZTogQ29tcG9uZW50VHlwZS5BY3Rpb25Sb3csXG5cdFx0XHRcdFx0Y29tcG9uZW50czogW1xuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHR0eXBlOiBDb21wb25lbnRUeXBlLkJ1dHRvbixcblx0XHRcdFx0XHRcdFx0bGFiZWw6ICdVbmJhbicsXG5cdFx0XHRcdFx0XHRcdHN0eWxlOiBCdXR0b25TdHlsZS5EYW5nZXIsXG5cdFx0XHRcdFx0XHRcdGN1c3RvbUlkOiBCdXR0b25zLlVuYmFuLmlkICsgJy8nICsgdXNlci5pZFxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdF1cblx0XHRcdFx0fVxuXHRcdFx0XVxuXHRcdH0pXG5cdH1cblxuXHQvLyBUZXN0IG1vZGUgLSBkb24ndCBleGVjdXRlIGJhblxuXHRjb25zdCB0ZXN0ID0gKGludGVyYWN0aW9uOiBNb2RhbFN1Ym1pdEludGVyYWN0aW9uIHwgQ2hhdElucHV0Q29tbWFuZEludGVyYWN0aW9uKSA9PiB7XG5cdFx0aWYgKHRlc3RNb2RlKSB7XG5cdFx0XHRpbnRlcmFjdGlvbi5yZXBseSh7XG5cdFx0XHRcdGVtYmVkczogW1xuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHRpdGxlOiAnVGVzdCBtb2RlJyxcblx0XHRcdFx0XHRcdGRlc2NyaXB0aW9uOiAnVGhpcyBpcyBhIHRlc3QuIE5vIGFjdGlvbiBoYXMgYmVlbiB0YWtlbi4nLFxuXHRcdFx0XHRcdFx0Y29sb3I6IENvbG9ycy5ZZWxsb3csXG5cdFx0XHRcdFx0XHRmb290ZXI6IHtcblx0XHRcdFx0XHRcdFx0dGV4dDogKGxvZ3NDaGFubmVsSWQgPyAnU2VlJyA6ICdTZXR1cCcpICsgYCBtb2Rsb2dzIGNoYW5uZWwgZm9yIGRldGFpbHNgXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRdLFxuXHRcdFx0XHRlcGhlbWVyYWw6IHRydWVcblx0XHRcdH0pXG5cdFx0XHRyZXR1cm4gdHJ1ZVxuXHRcdH1cblx0fVxuXG5cdC8vIFNob3cgY29uZmlybWF0aW9uIG1vZGFsIGlmIHJlcXVpcmVkXG5cdGlmIChyZXF1aXJlQ29uZmlybWF0aW9uKSB7XG5cdFx0YXdhaXQgc2hvd0NvbmZpcm1hdGlvbihpbnRlcmFjdGlvbiwgKGludGVyYWN0aW9uOiBNb2RhbFN1Ym1pdEludGVyYWN0aW9uKSA9PiB7XG5cdFx0XHRpZiAoIXRlc3QoaW50ZXJhY3Rpb24pKSB7XG5cdFx0XHRcdGV4ZWN1dGUoaW50ZXJhY3Rpb24pXG5cdFx0XHR9XG5cdFx0fSlcblx0XHRyZXR1cm5cblx0fVxuXG5cdGlmICh0ZXN0KGludGVyYWN0aW9uKSkge1xuXHRcdHJldHVyblxuXHR9XG5cdGV4ZWN1dGUoaW50ZXJhY3Rpb24pXG5cblx0aWYgKGFub255bW91cykge1xuXHRcdGludGVyYWN0aW9uLmNoYW5uZWw/LnNlbmQobWVzc2FnZVBheWxvYWQgYXMgTWVzc2FnZUNyZWF0ZU9wdGlvbnMpXG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0Y29udGVudDogJ0JhbiBoYXMgYmVlbiBleGVjdXRlZC4nLFxuXHRcdFx0ZXBoZW1lcmFsOiB0cnVlXG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIG1lc3NhZ2VQYXlsb2FkXG59XG5cbmV4cG9ydCBjb25zdCBhdXRvY29tcGxldGUgPSBhdXRvY29tcGxldGVEZWxldGVNZXNzYWdlc1xuIl0sIm5hbWVzIjpbIkJ1dHRvbnMiLCJJRF9OQU1FU1BBQ0UiLCJhdXRvY29tcGxldGVEZWxldGVNZXNzYWdlcyIsImRlbGV0ZU1lc3NhZ2VzT3B0aW9ucyIsImdldFNldHRpbmdzIiwibG9nQWN0aW9uIiwic2hvd0NvbmZpcm1hdGlvbiIsIkZsYXNoY29yZSIsImxvZ2dlciIsIkJ1dHRvblN0eWxlIiwiQ29sb3JzIiwiQ29tcG9uZW50VHlwZSIsIlBlcm1pc3Npb25GbGFnc0JpdHMiLCJjb25maWciLCJkZWZhdWx0TWVtYmVyUGVybWlzc2lvbnMiLCJCYW5NZW1iZXJzIiwiZGVzY3JpcHRpb24iLCJkbVBlcm1pc3Npb24iLCJvcHRpb25zIiwibmFtZSIsInR5cGUiLCJyZXF1aXJlZCIsImF1dG9jb21wbGV0ZSIsImludGVyYWN0aW9uIiwiYW5vbnltb3VzIiwiZ2V0IiwidmFsdWUiLCJkZWxldGVNZXNzYWdlcyIsInVzZXIiLCJnZXRVc2VyIiwicmVhc29uIiwiZ3VpbGQiLCJtYXAiLCJvcHRpb24iLCJpbmNsdWRlcyIsIm1lbWJlclBlcm1pc3Npb25zIiwiaWQiLCJjbGllbnQiLCJsb2dzQ2hhbm5lbElkIiwicmVxdWlyZUNvbmZpcm1hdGlvbiIsInRlc3RNb2RlIiwiZ3VpbGRJZCIsImJpdGZpZWxkIiwiZmllbGRzIiwidG9TdHJpbmciLCJwdXNoIiwiZGVsZXRlZCIsImZpbmQiLCJtZXNzYWdlUGF5bG9hZCIsImVtYmVkcyIsImNvbG9yIiwiRGFya1JlZCIsInRpdGxlIiwidXNlcm5hbWUiLCJ0aHVtYm5haWwiLCJ1cmwiLCJkaXNwbGF5QXZhdGFyVVJMIiwiY29tcG9uZW50cyIsIkFjdGlvblJvdyIsIkJ1dHRvbiIsImxhYmVsIiwic3R5bGUiLCJEYW5nZXIiLCJjdXN0b21JZCIsIlVuYmFuIiwiZXhlY3V0ZSIsIndhcm4iLCJtZW1iZXJzIiwiYmFuIiwic2V0IiwibmFtZXNwYWNlIiwiaW5mbyIsImNoYW5uZWxJZCIsInRlc3RQcmVmaXgiLCJ0aW1lc3RhbXAiLCJEYXRlIiwidG9JU09TdHJpbmciLCJmb290ZXIiLCJpY29uX3VybCIsInRleHQiLCJyZXBseSIsInRlc3QiLCJZ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