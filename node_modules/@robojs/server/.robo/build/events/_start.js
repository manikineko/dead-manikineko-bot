import { logger } from "../core/logger.js";
import { hasDependency } from "../core/runtime-utils.js";
import { _readyPromiseResolve } from "../../../.robo/build/core/plugin-utils.js";
import { existsSync } from "node:fs";
import path from "node:path";
import { portal } from "robo.js";
const PATH_REGEX = new RegExp(/\[(.+?)\]/g);
export let pluginOptions = {};
export default (async (_client, options)=>{
    pluginOptions = options ?? {};
    // Set default options
    if (pluginOptions.prefix === undefined) {
        pluginOptions.prefix = '/api';
    }
    if (!pluginOptions.engine) {
        pluginOptions.engine = await getDefaultEngine();
    }
    // Start HTTP server only if API Routes are defined
    const { engine , port =parseInt(process.env.PORT ?? '3000')  } = pluginOptions;
    let vite = pluginOptions.vite;
    logger.debug(`Preparing server with ${portal.apis.size} API routes...`);
    await engine.init({
        vite
    });
    // If Vite is available, start the dev server
    if (vite) {
        logger.debug('Using Vite server specified in options.');
    } else if (process.env.NODE_ENV !== 'production' && await hasDependency('vite', true)) {
        try {
            const { createServer: createViteServer  } = await import("vite");
            const viteConfigPath = path.join(process.cwd(), 'config', 'vite.mjs');
            vite = await createViteServer({
                configFile: existsSync(viteConfigPath) ? viteConfigPath : undefined,
                server: {
                    hmr: {
                        path: '/hmr',
                        server: engine.getHttpServer()
                    },
                    middlewareMode: {
                        server: engine.getHttpServer()
                    }
                }
            });
            logger.debug('Vite server created successfully.');
        } catch (e) {
            logger.error(`Failed to start Vite server:`, e);
        }
    }
    // Setup Vite if available and register socket bypass
    if (vite) {
        await engine.setupVite(vite);
        // Prevent other plugins from registering the HMR route
        engine.registerWebsocket('/hmr', ()=>{
            logger.debug('Vite HMR connection detected. Skipping registration...');
        });
    }
    // Add loaded API modules onto new router instance
    const prefix = pluginOptions.prefix ?? '';
    const paths = [];
    portal.apis.forEach((api)=>{
        const key = prefix + '/' + api.key.replace(PATH_REGEX, ':$1');
        paths.push(key);
        engine.registerRoute(key, api.handler.default);
    });
    logger.debug(`Starting server...`);
    await engine.start({
        port
    });
    _readyPromiseResolve();
});
async function getDefaultEngine() {
    // Return Fastify if available
    const isFastifyAvailable = await hasDependency('fastify');
    if (isFastifyAvailable) {
        logger.debug('Fastify is available. Using it as the server engine.');
        const { FastifyEngine  } = await import("../engines/fastify.js");
        return new FastifyEngine();
    }
    // Default engine
    logger.debug('Using Node.js as the server engine.');
    const { NodeEngine  } = await import("../engines/node.js");
    return new NodeEngine();
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3JrL3JvYm8uanMvcm9iby5qcy9wYWNrYWdlcy9wbHVnaW4tYXBpL3NyYy9ldmVudHMvX3N0YXJ0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2NvcmUvbG9nZ2VyLmpzJ1xuaW1wb3J0IHsgaGFzRGVwZW5kZW5jeSB9IGZyb20gJy4uL2NvcmUvcnVudGltZS11dGlscy5qcydcbmltcG9ydCB7IF9yZWFkeVByb21pc2VSZXNvbHZlIH0gZnJvbSAnfi9jb3JlL3BsdWdpbi11dGlscy5qcydcbmltcG9ydCB7IGV4aXN0c1N5bmMgfSBmcm9tICdub2RlOmZzJ1xuaW1wb3J0IHBhdGggZnJvbSAnbm9kZTpwYXRoJ1xuaW1wb3J0IHsgcG9ydGFsIH0gZnJvbSAncm9iby5qcydcbmltcG9ydCB0eXBlIHsgQmFzZUVuZ2luZSB9IGZyb20gJy4uL2VuZ2luZXMvYmFzZS5qcydcbmltcG9ydCB0eXBlIHsgQ2xpZW50IH0gZnJvbSAnZGlzY29yZC5qcydcbmltcG9ydCB0eXBlIHsgVml0ZURldlNlcnZlciB9IGZyb20gJ3ZpdGUnXG5cbmNvbnN0IFBBVEhfUkVHRVggPSBuZXcgUmVnRXhwKC9cXFsoLis/KVxcXS9nKVxuXG5pbnRlcmZhY2UgUGx1Z2luT3B0aW9ucyB7XG5cdGNvcnM/OiBib29sZWFuXG5cdGVuZ2luZT86IEJhc2VFbmdpbmVcblx0cGFyc2VCb2R5PzogYm9vbGVhblxuXHRwb3J0PzogbnVtYmVyXG5cdHByZWZpeD86IHN0cmluZyB8IG51bGwgfCBmYWxzZVxuXHR2aXRlPzogVml0ZURldlNlcnZlclxufVxuXG5leHBvcnQgbGV0IHBsdWdpbk9wdGlvbnM6IFBsdWdpbk9wdGlvbnMgPSB7fVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAoX2NsaWVudDogQ2xpZW50LCBvcHRpb25zOiBQbHVnaW5PcHRpb25zKSA9PiB7XG5cdHBsdWdpbk9wdGlvbnMgPSBvcHRpb25zID8/IHt9XG5cblx0Ly8gU2V0IGRlZmF1bHQgb3B0aW9uc1xuXHRpZiAocGx1Z2luT3B0aW9ucy5wcmVmaXggPT09IHVuZGVmaW5lZCkge1xuXHRcdHBsdWdpbk9wdGlvbnMucHJlZml4ID0gJy9hcGknXG5cdH1cblx0aWYgKCFwbHVnaW5PcHRpb25zLmVuZ2luZSkge1xuXHRcdHBsdWdpbk9wdGlvbnMuZW5naW5lID0gYXdhaXQgZ2V0RGVmYXVsdEVuZ2luZSgpXG5cdH1cblxuXHQvLyBTdGFydCBIVFRQIHNlcnZlciBvbmx5IGlmIEFQSSBSb3V0ZXMgYXJlIGRlZmluZWRcblx0Y29uc3QgeyBlbmdpbmUsIHBvcnQgPSBwYXJzZUludChwcm9jZXNzLmVudi5QT1JUID8/ICczMDAwJykgfSA9IHBsdWdpbk9wdGlvbnNcblx0bGV0IHZpdGU6IFZpdGVEZXZTZXJ2ZXIgfCB1bmRlZmluZWQgPSBwbHVnaW5PcHRpb25zLnZpdGVcblxuXHRsb2dnZXIuZGVidWcoYFByZXBhcmluZyBzZXJ2ZXIgd2l0aCAke3BvcnRhbC5hcGlzLnNpemV9IEFQSSByb3V0ZXMuLi5gKVxuXHRhd2FpdCBlbmdpbmUuaW5pdCh7IHZpdGUgfSlcblxuXHQvLyBJZiBWaXRlIGlzIGF2YWlsYWJsZSwgc3RhcnQgdGhlIGRldiBzZXJ2ZXJcblx0aWYgKHZpdGUpIHtcblx0XHRsb2dnZXIuZGVidWcoJ1VzaW5nIFZpdGUgc2VydmVyIHNwZWNpZmllZCBpbiBvcHRpb25zLicpXG5cdH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAoYXdhaXQgaGFzRGVwZW5kZW5jeSgndml0ZScsIHRydWUpKSkge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB7IGNyZWF0ZVNlcnZlcjogY3JlYXRlVml0ZVNlcnZlciB9ID0gYXdhaXQgaW1wb3J0KCd2aXRlJylcblx0XHRcdGNvbnN0IHZpdGVDb25maWdQYXRoID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksICdjb25maWcnLCAndml0ZS5tanMnKVxuXG5cdFx0XHR2aXRlID0gYXdhaXQgY3JlYXRlVml0ZVNlcnZlcih7XG5cdFx0XHRcdGNvbmZpZ0ZpbGU6IGV4aXN0c1N5bmModml0ZUNvbmZpZ1BhdGgpID8gdml0ZUNvbmZpZ1BhdGggOiB1bmRlZmluZWQsXG5cdFx0XHRcdHNlcnZlcjoge1xuXHRcdFx0XHRcdGhtcjogeyBwYXRoOiAnL2htcicsIHNlcnZlcjogZW5naW5lLmdldEh0dHBTZXJ2ZXIoKSB9LFxuXHRcdFx0XHRcdG1pZGRsZXdhcmVNb2RlOiB7IHNlcnZlcjogZW5naW5lLmdldEh0dHBTZXJ2ZXIoKSB9XG5cdFx0XHRcdH1cblx0XHRcdH0pXG5cdFx0XHRsb2dnZXIuZGVidWcoJ1ZpdGUgc2VydmVyIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5LicpXG5cdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0bG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gc3RhcnQgVml0ZSBzZXJ2ZXI6YCwgZSlcblx0XHR9XG5cdH1cblxuXHQvLyBTZXR1cCBWaXRlIGlmIGF2YWlsYWJsZSBhbmQgcmVnaXN0ZXIgc29ja2V0IGJ5cGFzc1xuXHRpZiAodml0ZSkge1xuXHRcdGF3YWl0IGVuZ2luZS5zZXR1cFZpdGUodml0ZSlcblxuXHRcdC8vIFByZXZlbnQgb3RoZXIgcGx1Z2lucyBmcm9tIHJlZ2lzdGVyaW5nIHRoZSBITVIgcm91dGVcblx0XHRlbmdpbmUucmVnaXN0ZXJXZWJzb2NrZXQoJy9obXInLCAoKSA9PiB7XG5cdFx0XHRsb2dnZXIuZGVidWcoJ1ZpdGUgSE1SIGNvbm5lY3Rpb24gZGV0ZWN0ZWQuIFNraXBwaW5nIHJlZ2lzdHJhdGlvbi4uLicpXG5cdFx0fSlcblx0fVxuXG5cdC8vIEFkZCBsb2FkZWQgQVBJIG1vZHVsZXMgb250byBuZXcgcm91dGVyIGluc3RhbmNlXG5cdGNvbnN0IHByZWZpeCA9IHBsdWdpbk9wdGlvbnMucHJlZml4ID8/ICcnXG5cdGNvbnN0IHBhdGhzOiBzdHJpbmdbXSA9IFtdXG5cblx0cG9ydGFsLmFwaXMuZm9yRWFjaCgoYXBpKSA9PiB7XG5cdFx0Y29uc3Qga2V5ID0gcHJlZml4ICsgJy8nICsgYXBpLmtleS5yZXBsYWNlKFBBVEhfUkVHRVgsICc6JDEnKVxuXHRcdHBhdGhzLnB1c2goa2V5KVxuXHRcdGVuZ2luZS5yZWdpc3RlclJvdXRlKGtleSwgYXBpLmhhbmRsZXIuZGVmYXVsdClcblx0fSlcblxuXHRsb2dnZXIuZGVidWcoYFN0YXJ0aW5nIHNlcnZlci4uLmApXG5cdGF3YWl0IGVuZ2luZS5zdGFydCh7IHBvcnQgfSlcblx0X3JlYWR5UHJvbWlzZVJlc29sdmUoKVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZWZhdWx0RW5naW5lKCkge1xuXHQvLyBSZXR1cm4gRmFzdGlmeSBpZiBhdmFpbGFibGVcblx0Y29uc3QgaXNGYXN0aWZ5QXZhaWxhYmxlID0gYXdhaXQgaGFzRGVwZW5kZW5jeSgnZmFzdGlmeScpXG5cdGlmIChpc0Zhc3RpZnlBdmFpbGFibGUpIHtcblx0XHRsb2dnZXIuZGVidWcoJ0Zhc3RpZnkgaXMgYXZhaWxhYmxlLiBVc2luZyBpdCBhcyB0aGUgc2VydmVyIGVuZ2luZS4nKVxuXHRcdGNvbnN0IHsgRmFzdGlmeUVuZ2luZSB9ID0gYXdhaXQgaW1wb3J0KCcuLi9lbmdpbmVzL2Zhc3RpZnkuanMnKVxuXHRcdHJldHVybiBuZXcgRmFzdGlmeUVuZ2luZSgpXG5cdH1cblxuXHQvLyBEZWZhdWx0IGVuZ2luZVxuXHRsb2dnZXIuZGVidWcoJ1VzaW5nIE5vZGUuanMgYXMgdGhlIHNlcnZlciBlbmdpbmUuJylcblx0Y29uc3QgeyBOb2RlRW5naW5lIH0gPSBhd2FpdCBpbXBvcnQoJy4uL2VuZ2luZXMvbm9kZS5qcycpXG5cdHJldHVybiBuZXcgTm9kZUVuZ2luZSgpXG59XG4iXSwibmFtZXMiOlsibG9nZ2VyIiwiaGFzRGVwZW5kZW5jeSIsIl9yZWFkeVByb21pc2VSZXNvbHZlIiwiZXhpc3RzU3luYyIsInBhdGgiLCJwb3J0YWwiLCJQQVRIX1JFR0VYIiwiUmVnRXhwIiwicGx1Z2luT3B0aW9ucyIsIl9jbGllbnQiLCJvcHRpb25zIiwicHJlZml4IiwidW5kZWZpbmVkIiwiZW5naW5lIiwiZ2V0RGVmYXVsdEVuZ2luZSIsInBvcnQiLCJwYXJzZUludCIsInByb2Nlc3MiLCJlbnYiLCJQT1JUIiwidml0ZSIsImRlYnVnIiwiYXBpcyIsInNpemUiLCJpbml0IiwiTk9ERV9FTlYiLCJjcmVhdGVTZXJ2ZXIiLCJjcmVhdGVWaXRlU2VydmVyIiwidml0ZUNvbmZpZ1BhdGgiLCJqb2luIiwiY3dkIiwiY29uZmlnRmlsZSIsInNlcnZlciIsImhtciIsImdldEh0dHBTZXJ2ZXIiLCJtaWRkbGV3YXJlTW9kZSIsImUiLCJlcnJvciIsInNldHVwVml0ZSIsInJlZ2lzdGVyV2Vic29ja2V0IiwicGF0aHMiLCJmb3JFYWNoIiwiYXBpIiwia2V5IiwicmVwbGFjZSIsInB1c2giLCJyZWdpc3RlclJvdXRlIiwiaGFuZGxlciIsImRlZmF1bHQiLCJzdGFydCIsImlzRmFzdGlmeUF2YWlsYWJsZSIsIkZhc3RpZnlFbmdpbmUiLCJOb2RlRW5naW5lIl0sIm1hcHBpbmdzIjoiQUFBQSxTQUFTQSxNQUFNLFFBQVEsb0JBQW1CO0FBQzFDLFNBQVNDLGFBQWEsUUFBUSwyQkFBMEI7QUFDeEQsU0FBU0Msb0JBQW9CLFFBQVEsNENBQXdCO0FBQzdELFNBQVNDLFVBQVUsUUFBUSxVQUFTO0FBQ3BDLE9BQU9DLFVBQVUsWUFBVztBQUM1QixTQUFTQyxNQUFNLFFBQVEsVUFBUztBQUtoQyxNQUFNQyxhQUFhLElBQUlDLE9BQU87QUFXOUIsT0FBTyxJQUFJQyxnQkFBK0IsQ0FBQyxFQUFDO0FBRTVDLGVBQWUsQ0FBQSxPQUFPQyxTQUFpQkMsVUFBMkI7SUFDakVGLGdCQUFnQkUsV0FBVyxDQUFDO0lBRTVCLHNCQUFzQjtJQUN0QixJQUFJRixjQUFjRyxNQUFNLEtBQUtDLFdBQVc7UUFDdkNKLGNBQWNHLE1BQU0sR0FBRztJQUN4QixDQUFDO0lBQ0QsSUFBSSxDQUFDSCxjQUFjSyxNQUFNLEVBQUU7UUFDMUJMLGNBQWNLLE1BQU0sR0FBRyxNQUFNQztJQUM5QixDQUFDO0lB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